# Домашнее задание к занятию "08.02 Работа с Playbook"

## Решение

По заданию подготовлен playbook для подготовки хостов с Elasticsearch и Kibana. По одному хосту каждого типа.

[Inventory](./inventory/prod.yml)

Окружение создано на основе докер контейнеров CentOS 7. Окружение учебное, после отработки playbook запуск сервисов необходимо сделать в ручном режиме.

В первом окне:
```commandline
# docker run -it --rm --name elastic01 -p 9200:9200 centos:7
```

Во втором окне:
```commandline
# docker run -it --rm --name kibana01 -p 5601:5601 centos:7
```

[Playbook](./site.yml)

Доступные теги - java, elastic, kibana.

   * java - Задачи с этим тегом выполняют установку Java на целевые хосты.
   * elastic - Задачи с этим тегом выполняют установку Elasticsearch на целевые хосты. 
   * kibana - Задачи с этим тегом выполняют установку Kibana на целевые хосты. 

Playbook состоит из следующих задач для групп хостов:
1. Для всех хостов в [inventory](./inventory/prod.yml) (тег - java):
    * Сбор фактов
    * Установка переменной java_home, используя значения из параметров [group vars for all](./group_vars/all/vars.yml)
    * Копируется файл .tar.gz из локального хранилища
    * Создается директория для установки, если она не существует. Используется переменная java_home, права на папку 0644
    * Распаковывается ранее скопированный архив в подготовленную директорию
    * Подготавливается скрипт для установки переменных окружения /etc/profile.d/jdk.sh из [шаблона](./templates/jdk.sh.j2)

2. Для хостов из группы elasticsearch в [inventory](./inventory/prod.yml) (тег - elastic):
    * Сбор фактов, значений параметров [group vars for elasticsearch](./group_vars/elasticsearch/vars.yml)
    * Создается переменная elastic_ip в которой содержится stdout команды `hostname -i`, ip адрес хоста.
    * Создается группа elastic, если она не существует
    * Создается пользователь elastic с шеллом /bin/bash и группой elastic, если он не существует.
    * Копируется файл .tar.gz с URL во временную директорию
    * Создается директория для установки, если она не существует. Используется переменная elastic_home, права на папку 0755, владелец elastic
    * Распаковывается ранее скопированный архив в подготовленную директорию
    * Подготавливается скрипт для установки переменных окружения /etc/profile.d/elk.sh из [шаблона](./templates/elk.sh.j2)
    * В файле `{{ elastic_home }}/config/elasticsearch.yml` ищется выражение `^#network.host: 192.168.0.1` и заменяется на `network.host: 0.0.0.0`. Если не находится, то не заменяется. Это обеспечивает идемпотентность.

3. Для хостов из группы kibana в [inventory](./inventory/prod.yml) (тег - kibana):
    * Сбор фактов, значений параметров [group vars for kibana](./group_vars/kibana/vars.yml)
    * Переменная elastic_ip берется из предидущего прогона для хоста elastic01.
    * Создается группа kibana, если она не существует
    * Создается пользователь kibana с шеллом /bin/bash и группой kibana, если он не существует.
    * Копируется файл .tar.gz с URL во временную директорию
    * Создается директория для установки, если она не существует. Используется переменная kibana_home, права на папку 0755, владелец kibana
    * Распаковывается ранее скопированный архив в подготовленную директорию
    * В файле `{{ kibana_home }}/config/kibana.yml` ищется выражение `^#server.host` и заменяется на `server.host: 0.0.0.0`. Для открытия порта kibana 5601/tcp на всех сетевых интефейсах. Если не находится, то не заменяется. Это обеспечивает идемпотентность.
    * Подготавливается скрипт для установки переменных окружения /etc/profile.d/kibana.sh из [шаблона](./templates/kibana.sh.j2)
    * В файле `{{ kibana_home }}/config/kibana.yml` ищется выражение `^#elasticsearch.hosts: \["http://localhost:9200"\]` и заменяется на `elasticsearch.hosts: ["http://{{ elastic_ip }}:9200"]`. Для соединения с сервером Elasticsearch. Если не находится, то не заменяется. Это обеспечивает идемпотентность.